

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Datasets &mdash; mlcg 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=01f34227"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Priors" href="priors.html" />
    <link rel="prev" title="Coarse Graining" href="coarse_graining.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            mlcg
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="data.html">Data Representation</a></li>
<li class="toctree-l1"><a class="reference internal" href="geometry.html">Geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="neighbor_list.html">Neighbor Lists</a></li>
<li class="toctree-l1"><a class="reference internal" href="coarse_graining.html">Coarse Graining</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Datasets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#chignolin-dataset">Chignolin Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="#alanine-dipeptide-dataset">Alanine Dipeptide Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="#custom-h5-dataset">Custom H5 Dataset</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#inroduction">Inroduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#basic-bricks-moldata-and-metaset">Basic bricks: <code class="docutils literal notranslate"><span class="pre">MolData</span></code> and <code class="docutils literal notranslate"><span class="pre">MetaSet</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#train-test-split-partition">Train test split: <code class="docutils literal notranslate"><span class="pre">Partition</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#full-dataset-h5dataset">Full Dataset: <code class="docutils literal notranslate"><span class="pre">H5Dataset</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#loading-into-pytorch-h5partitiondataloader">Loading into PyTorch: <code class="docutils literal notranslate"><span class="pre">H5PartitionDataLoader</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="priors.html">Priors</a></li>
<li class="toctree-l1"><a class="reference internal" href="models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="simulation.html">Simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev/dev.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="bibliography.html">Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">mlcg</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Datasets</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/datasets.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="datasets">
<h1>Datasets<a class="headerlink" href="#datasets" title="Link to this heading"></a></h1>
<p><code class="docutils literal notranslate"><span class="pre">mlcg.datasets</span></code> contains a template <code class="docutils literal notranslate"><span class="pre">InMemoryDataset</span></code> for CLN025, a 10 amino acid long mini protein that shows prototypical folding and unfolding behavior. The <code class="docutils literal notranslate"><span class="pre">ChignolinDataset</span></code> class illustrates how a general dataset can be downloaded, unpacked/organized, transformed/processed, and collated for training models. <a class="reference external" href="https://pytorch-geometric.readthedocs.io/en/latest/notes/create_dataset.html">Here</a>, users can find more information on implementing custom datasets.</p>
<section id="chignolin-dataset">
<h2>Chignolin Dataset<a class="headerlink" href="#chignolin-dataset" title="Link to this heading"></a></h2>
<p>Dataset of 3744 individual all-atom trajectories simulated using <a class="reference internal" href="bibliography.html#acemd" id="id1"><span>[ACEMD]</span></a> using the adaptive sampling strategy described in <a class="reference internal" href="bibliography.html#adaptivestrategy" id="id2"><span>[AdaptiveStrategy]</span></a> . All trajectories were simulated at 350K with <a class="reference internal" href="bibliography.html#charm22star" id="id3"><span>[CHARM22Star]</span></a> in a cubic box of 40 angstroms :sup:<code class="docutils literal notranslate"><span class="pre">3</span></code> with 1881 TIP3P water molecules and two Na :sup:<code class="docutils literal notranslate"><span class="pre">+</span></code> ions using a Langevin integrator with an integration timestep of 4 fs, a damping constant of 0.1 :sup:<code class="docutils literal notranslate"><span class="pre">-1</span></code> ps, heavy-hydrogen constraints, and a PME cutoff of 9 angstroms and a PME mesh grid of 1 angstrom. The total aggregate simulation time is 187.2 us.</p>
</section>
<section id="alanine-dipeptide-dataset">
<h2>Alanine Dipeptide Dataset<a class="headerlink" href="#alanine-dipeptide-dataset" title="Link to this heading"></a></h2>
<p>Dataset of a single 1M step trajectory of alanine dipeptide in explicit water. The trajectory is simulated using a Langevin scheme with <a class="reference internal" href="bibliography.html#acemd" id="id4"><span>[ACEMD]</span></a> at 300K through the <a class="reference internal" href="bibliography.html#amber-ff-99sb-ildn" id="id5"><span>[AMBER_ff_99SB_ILDN]</span></a> force force field. The cubic simulation box was 2.3222 cubic nm, an integration timestep of 2 fs was used, the solvent was composed of 651 <a class="reference internal" href="bibliography.html#tip3p" id="id6"><span>[TIP3P]</span></a> water molecules, electrostatics were computed every two steps using the PME method with a real-space cutoff of 9 nm and a grid spacing of 0.1 nm, and all bonds between heavy and hydrogen atoms were constrained.</p>
</section>
<section id="custom-h5-dataset">
<h2>Custom H5 Dataset<a class="headerlink" href="#custom-h5-dataset" title="Link to this heading"></a></h2>
<p>Users may assemble their own curated dataset using an H5 format. This allows for the possiblity of training on multiple types of molecules or data from different system conditiions.</p>
<section id="inroduction">
<h3>Inroduction<a class="headerlink" href="#inroduction" title="Link to this heading"></a></h3>
<p>HDF5 format benefits the dataset management for mlcg when training/validation involves multiple molecules of vastly different lengths and when parallelization is used.
The main features are:</p>
<ol class="arabic simple">
<li><p>The internal structure mimics the hierarchy of the dataset itself, such that we don’t have to replicate it on filesystem.</p></li>
<li><p>we don’t have to actively open all files in the process</p></li>
<li><p>we can transparently load only the necessary part of the dataset to the memory</p></li>
</ol>
<p>This file contains the python data structures for handling the HDF5 file and its content, i.e., the coordinates, forces and embedding vectors for multiple CG molecules.
An example HDF5 file structure and correponding class types after loading:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/ (HDF-group, =&gt; ``H5Dataset._h5_root``)
├── OPEP (HDF-group =(part, according to &quot;partition_options&quot;)=&gt; ``Metaset`` in a ``Partition``)
│   ├── opep_0000 (HDF-group, =&gt; ``MolData``)
│   │   ├── attrs (HDF-attributes of the molecule &quot;/OPEP/opep_0000&quot;)
│   │   │   ├── cg_embeds (a 1-d numpy.int array)
│   │   │   ├── N_frames (int, number of frames = size of cg_coords on axis 0)
│   │   │   ... (optional, e.g., cg_exc_pairs cg_top, cg_pdb, etc that corrsponds to the molecule)
│   │   ├── cg_coords (HDF-dataset of the molecule &quot;/OPEP/opep_0000&quot;, 3-d numpy.float32 array)
│   │   └── cg(_delta)_forces (HDF-dataset of the molecule &quot;/OPEP/opep_0000&quot;, 3-d numpy.float32 array)
│   ... (other molecules in &quot;/OPEP&quot;)
├── CATH (HDF-group =&quot;partition_options&quot;=&gt; ``Metaset`` in a ``Partition``)
...
</pre></div>
</div>
</section>
<section id="basic-bricks-moldata-and-metaset">
<h3>Basic bricks: <code class="docutils literal notranslate"><span class="pre">MolData</span></code> and <code class="docutils literal notranslate"><span class="pre">MetaSet</span></code><a class="headerlink" href="#basic-bricks-moldata-and-metaset" title="Link to this heading"></a></h3>
<p>Data structure <code class="docutils literal notranslate"><span class="pre">MolData</span></code> is the basic brick of the dataset.
It holds embeds, coords and forces of certain number of frames for a single molecule.
.sub_sample: method for performing indexing on the frames.</p>
<p>Data strcuture <code class="docutils literal notranslate"><span class="pre">Metaset</span></code> holds multiple molecules and joins their frame indices together.
One can access frames of underlying MolData objects with a continuous index.
The idea is that the molecules in a <code class="docutils literal notranslate"><span class="pre">Metaset</span></code> have similar numbers of CG beads, such that the sample requires similar processing time when passing through a neural network.
When this rule is enforced, it will allow automatic balancing of batch composition during training and validation.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.create_from_hdf5_group</span></code>: initiate a Metaset by loading data from given HDF-group.mol_list, detailed_indices, hdf_key_mapping, stride and parallel can control which subset is loaded to the Metaset (details see the description of “H5Dataset”)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.trim_down_to</span></code>: drop frames of underlying for obtaining a subset with desired number of frames. The indices of frames to be dropped are controlled by a random number generator. When the parameter “random_seed” and the MolData order and number of frames are the same, the frames to be dropped will be reproducible.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">len()</span> <span class="pre">(__len__)</span></code>: return total number of samples</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[]</span> <span class="pre">(__get_item__)</span></code>: infer the molecule and get the corresponding frame according to the given unified index. Return value is grouped by an <code class="docutils literal notranslate"><span class="pre">AtomicData</span></code> object.</p></li>
</ul>
</section>
<section id="train-test-split-partition">
<h3>Train test split: <code class="docutils literal notranslate"><span class="pre">Partition</span></code><a class="headerlink" href="#train-test-split-partition" title="Link to this heading"></a></h3>
<p>Data structure <code class="docutils literal notranslate"><span class="pre">Partition</span></code> can hold multiple Metaset for training and validation purposes.
Its main function is to automatic adjust (subsample) the Metaset(s) and the underlying MolData to form a balanced data source, from which a certain number of batches can be drawn. Each batch will contain a pre-given number of samples from each Metaset.
One or several <code class="docutils literal notranslate"><span class="pre">Partition``s</span> <span class="pre">can</span> <span class="pre">be</span> <span class="pre">created</span> <span class="pre">to</span> <span class="pre">load</span> <span class="pre">part</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">same</span> <span class="pre">HDF5</span> <span class="pre">file</span> <span class="pre">into</span> <span class="pre">the</span> <span class="pre">memory.</span>
<span class="pre">The</span> <span class="pre">exact</span> <span class="pre">content</span> <span class="pre">inside</span> <span class="pre">a</span> <span class="pre">``Partition</span></code> object is controlled by the <code class="docutils literal notranslate"><span class="pre">partition_options</span></code> as a parameter for initializing a <code class="docutils literal notranslate"><span class="pre">H5Dataset</span></code>.</p>
</section>
<section id="full-dataset-h5dataset">
<h3>Full Dataset: <code class="docutils literal notranslate"><span class="pre">H5Dataset</span></code><a class="headerlink" href="#full-dataset-h5dataset" title="Link to this heading"></a></h3>
<p>Data strcuture <code class="docutils literal notranslate"><span class="pre">H5Dataset</span></code> opens a HDF5 file and establish the partitions.
<code class="docutils literal notranslate"><span class="pre">partition_options</span></code> describe what partitions to create and what content to load into them. (Detailed description and examples are as followed.)
<code class="docutils literal notranslate"><span class="pre">loading_options</span></code> mainly deal with the HDF key mapping (which datasets/attributes corresponds to the coordinates, forces and embeddings) as well as (optionally) the information for correctly split the dataset in a parallel training/validation.</p>
<p>An example “partition_options” (as a Python Mappable (e.g., dict)):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
        <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;metasets&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;OPEP&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;molecules&quot;</span><span class="p">:</span> <span class="p">[</span>
                                        <span class="s2">&quot;opep_0000&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;opep_0001&quot;</span><span class="p">,</span>
                                        <span class="o">...</span>
                                <span class="p">],</span>
                                <span class="s2">&quot;stride&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># optional, default 1</span>
                                <span class="s2">&quot;detailed_indices&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1"># optional, providing the indices of frames to work with (before striding and splitting for parallel processes).</span>
                                        <span class="c1"># optional,</span>
                    <span class="s2">&quot;opep_0000&quot;</span><span class="p">:</span>
                        <span class="n">val_ratio</span><span class="p">:</span> <span class="mf">0.1</span>
                        <span class="n">test_ratio</span><span class="p">:</span> <span class="mf">0.1</span>
                        <span class="n">seed</span><span class="p">:</span> <span class="mi">12345</span>
                    <span class="s2">&quot;opep_0001&quot;</span><span class="p">:</span>
                        <span class="n">val_ratio</span><span class="p">:</span> <span class="mf">0.1</span>
                        <span class="n">test_ratio</span><span class="p">:</span> <span class="mf">0.1</span>
                        <span class="n">seed</span><span class="p">:</span> <span class="mi">12345</span>
                    <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="o">./</span><span class="n">splits</span>

                <span class="c1"># If detailed_indices are not provided for a given molecule, then it is equivalent to np.arange(N_frames)</span>
                                            <span class="s2">&quot;opep_0000&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>


                                <span class="p">},</span>
                        <span class="p">},</span>
                        <span class="s2">&quot;CATH&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;molecules&quot;</span><span class="p">:</span> <span class="p">[</span>
                                        <span class="s2">&quot;cath_1b43A02&quot;</span><span class="p">,</span>
                                        <span class="o">...</span>
                                <span class="p">],</span>
                                <span class="s2">&quot;stride&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># optional</span>
                                <span class="s2">&quot;detailed_indices&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="c1"># optional</span>
                        <span class="p">}</span>
                <span class="p">},</span>
                <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="c1"># each batch will contain 24 samples from</span>
                        <span class="c1"># The two metasets will be trimmed down according to this ratio</span>
                        <span class="c1"># so optimally it should be proportional to the ratio of numbers of frames in the metasets.</span>
                        <span class="s2">&quot;OPEP&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
                        <span class="s2">&quot;CATH&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;subsample_random_seed&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="c1"># optional, default 42. Random seed for trimming down the frames.</span>
                <span class="s2">&quot;max_epoch_samples&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># optional, default None. For setting a desired dataset size.</span>
                <span class="c1"># Works by subsampling the dataset after it is loaded with the given stride.</span>
        <span class="p">},</span>
        <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># similar</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>An example “loading_options” (as a Python Mappable (e.g., dict)):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
        <span class="s2">&quot;hdf_key_mapping&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1"># keys for reading CG data from HDF5 groups</span>
                <span class="s2">&quot;embeds&quot;</span><span class="p">:</span> <span class="s2">&quot;attrs:cg_embeds&quot;</span><span class="p">,</span>
                <span class="s2">&quot;coords&quot;</span><span class="p">:</span> <span class="s2">&quot;cg_coords&quot;</span><span class="p">,</span>
                <span class="s2">&quot;forces&quot;</span><span class="p">:</span> <span class="s2">&quot;cg_delta_forces&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;parallel&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># optional, default rank=0 and world_size=1 (single process).</span>
                <span class="c1"># For split the dataset evenly and load only the necessary parts to each process in a parallelized train/val setup</span>
                <span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># which process is this</span>
                <span class="s2">&quot;world_size&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># how many processes are there</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="loading-into-pytorch-h5partitiondataloader">
<h3>Loading into PyTorch: <code class="docutils literal notranslate"><span class="pre">H5PartitionDataLoader</span></code><a class="headerlink" href="#loading-into-pytorch-h5partitiondataloader" title="Link to this heading"></a></h3>
<p>Class <code class="docutils literal notranslate"><span class="pre">H5PartitionDataLoader</span></code> mimics the pytorch data loader and can generate training/validation batches with fixed proportion of samples from several Metasets in a Partition.
The proportion and batch size is defined when the partition is initialized.
When the molecules in each Metaset have similar embedding vector lengths, the processing of output batches will require a more or less fixed size of VRAM on GPU, which can benefit the</p>
<p>Note:
1. Usually in a train-val split, each molecule goes to either the train or the test partition.</p>
<blockquote>
<div><p>In some special cases (e.g., non-transferable training) one molecule can be part of both partitions.
In this situation, “detailed_indices” can be set to assign the corresponding frames to the desired partitions.</p>
</div></blockquote>
<p>In addition one can pass in detailed_indices as a dictionary to split frames based on training/test (see partition_options example above)</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="coarse_graining.html" class="btn btn-neutral float-left" title="Coarse Graining" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="priors.html" class="btn btn-neutral float-right" title="Priors" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Felix Musil &amp; Nick Charron.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>